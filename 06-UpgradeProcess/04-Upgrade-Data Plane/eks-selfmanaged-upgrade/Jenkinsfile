pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  parameters {
    string(
      name: 'CLUSTER_NAME',
      defaultValue: 'prod-eks',
      description: 'EKS cluster name'
    )
    string(
      name: 'AWS_REGION',
      defaultValue: 'us-east-1',
      description: 'AWS region'
    )
    string(
      name: 'K8S_VERSION',
      defaultValue: '1.34',
      description: 'Target Kubernetes version for worker nodes'
    )
    booleanParam(
      name: 'APPLY',
      defaultValue: false,
      description: 'Approve creation of new ASG and draining of old nodes'
    )
  }

  environment {
    AWS_DEFAULT_REGION        = "${params.AWS_REGION}"
    TF_VAR_cluster_name       = "${params.CLUSTER_NAME}"
    TF_VAR_kubernetes_version = "${params.K8S_VERSION}"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Preflight Checks') {
      steps {
        sh '''
          echo "=== Cluster Nodes ==="
          kubectl get nodes

          echo "=== PodDisruptionBudgets ==="
          kubectl get pdb -A || true
        '''
      }
    }

    stage('Terraform Init') {
      steps {
        sh '''
          cd terraform
          terraform init -reconfigure
        '''
      }
    }

    stage('Terraform Validate') {
      steps {
        sh '''
          cd terraform
          terraform validate
        '''
      }
    }

    stage('Terraform Plan – New Launch Template & ASG') {
      steps {
        sh '''
          cd terraform
          terraform plan -out=tfplan
        '''
      }
    }

    stage('Manual Approval') {
      when {
        expression { params.APPLY == true }
      }
      steps {
        input message: """
APPROVAL REQUIRED

This action will:
1. Automatically look up the EKS-optimized AMI for Kubernetes ${params.K8S_VERSION}
2. Create a NEW Launch Template
3. Create a NEW Auto Scaling Group
4. Join new worker nodes to the cluster
5. Drain OLD worker nodes (one by one)

Rollback is possible because the old ASG remains intact.
"""
      }
    }

    stage('Terraform Apply – Create New ASG') {
      when {
        expression { params.APPLY == true }
      }
      steps {
        sh '''
          cd terraform
          terraform apply tfplan
        '''
      }
    }

    stage('Wait for New Nodes to Join') {
      when {
        expression { params.APPLY == true }
      }
      steps {
        sh '''
          echo "Waiting for new worker nodes (nodegroup=workers-v2) to become Ready..."

          until kubectl get nodes -l nodegroup=workers-v2 | grep -q Ready; do
            sleep 20
          done

          echo "New worker nodes are Ready"
        '''
      }
    }

    stage('Drain Old Worker Nodes') {
      when {
        expression { params.APPLY == true }
      }
      steps {
        sh '''
          chmod +x scripts/drain-old-nodes.sh
          ./scripts/drain-old-nodes.sh
        '''
      }
    }

    stage('Post-Upgrade Validation') {
      steps {
        sh '''
          echo "=== Nodes ==="
          kubectl get nodes -o wide

          echo "=== Non-Running Pods (if any) ==="
          kubectl get pods -A | grep -v Running || true
        '''
      }
    }
  }

  post {
    success {
      echo "✅ Self-managed EKS worker upgrade completed successfully"
    }
    failure {
      echo "❌ Upgrade failed – old ASG remains untouched for rollback"
    }
  }
}
