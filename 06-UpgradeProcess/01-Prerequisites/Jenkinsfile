pipeline {
  agent any

  environment {
    CLUSTER_NAME = "prod-eks"
    AWS_REGION   = "us-east-1"
    TARGET_K8S   = "1.34"
  }

  stages {

    stage('4.1 Add-on Compatibility Check') {
      steps {
        sh "./eks-preupgrade-check.sh ${CLUSTER_NAME} ${AWS_REGION} ${TARGET_K8S}"
      }
    }

    stage('4.2 API Deprecation Audit') {
      steps {
        sh "./api-deprecation-check.sh"
      }
    }

    stage('4.3 PDB Validation') {
      steps {
        sh "./pdb-preupgrade-check.sh"
      }
    }

    stage('4.4 Capacity & Scaling Readiness') {
      steps {
        sh "./capacity-scaling-check.sh"
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: '*.txt', fingerprint: true
    }
    success {
      echo "✅ PRE-UPGRADE CHECKS PASSED – SAFE TO PROCEED"
    }
    failure {
      echo "❌ PRE-UPGRADE CHECK FAILED – UPGRADE BLOCKED"
    }
  }
}
